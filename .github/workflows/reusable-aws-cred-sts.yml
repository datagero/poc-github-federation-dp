name: Reusable - AWS OIDC STS test (runs with caller identity)

on:
  workflow_call:
    inputs:
      caller_note:
        description: "Any text from the caller (for traceability)"
        required: true
        type: string
      aws_region:
        description: "AWS region"
        required: true
        type: string
      role_to_assume:
        description: "IAM role ARN to assume via GitHub OIDC"
        required: true
        type: string
    outputs:
      sts_arn:
        description: "Caller identity ARN"
        value: ${{ jobs.sts.outputs.sts_arn }}

permissions:
  id-token: write
  contents: read

jobs:
  sts:
    runs-on: ubuntu-latest
    outputs:
      sts_arn: ${{ steps.out.outputs.sts_arn }}
    steps:
      - name: Print context
        run: |
          echo "âœ… Remote reusable workflow running"
          echo "Repo:        ${{ github.repository }}"
          echo "Caller note: ${{ inputs.caller_note }}"

      - name: Assume AWS role via GitHub OIDC (caller identity)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.role_to_assume }}
          aws-region: ${{ inputs.aws_region }}

      - name: STS get-caller-identity
        id: sts
        shell: bash
        run: |
          aws sts get-caller-identity
          arn="$(aws sts get-caller-identity --query Arn --output text)"
          echo "arn=${arn}" >> "$GITHUB_OUTPUT"

      - name: Set output
        id: out
        run: |
          echo "sts_arn=${{ steps.sts.outputs.arn }}" >> "$GITHUB_OUTPUT"

